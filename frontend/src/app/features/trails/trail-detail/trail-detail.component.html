@if (!insideShell) { <hb-scene-background aria-hidden="true" /> }

<div class="detail-wrapper">
  @if (!insideShell) { <hb-navbar /> }

  @if (loading()) {
    <div class="state-message">Loading trail…</div>
  } @else if (error() || !trail()) {
    <div class="state-message state-message--error">Trail not found.</div>
  } @else {

    <main class="trail-detail">

      <!-- ── Hero ────────────────────────────────────────────────────── -->
      <section class="trail-hero">
        <div class="trail-chips">
          <span class="chip chip--{{ trail()!.difficulty.toLowerCase() }}">
            {{ trail()!.difficulty }}
          </span>
          <span class="chip">{{ trail()!.distanceKm }} km</span>
          <span class="chip">↑ {{ trail()!.elevationGainM }} m</span>
          <span class="chip">~ {{ formatDuration(trail()!.durationMinutes) }}</span>
        </div>

        <h1 class="trail-name">{{ trail()!.name }}</h1>
        <p class="trail-region">{{ trail()!.region.name }}, {{ trail()!.region.country }}</p>

        <div class="trail-rating">
          <div class="stars">
            @for (s of stars(trail()!.averageRating); track $index) {
              <span class="star" [class.star--filled]="s === 'filled'">★</span>
            }
          </div>
          <span class="rating-value">{{ trail()!.averageRating }}</span>
          <span class="rating-count">({{ trail()!.reviewCount }} reviews)</span>
        </div>

        @if (isLoggedIn()) {
          <div class="trail-action-row">
            <button
              class="btn-save"
              [class.btn-save--saved]="isSaved()"
              type="button"
              (click)="toggleFavorite()"
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"
                      [attr.fill]="isSaved() ? 'currentColor' : 'none'"
                      stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ isSaved() ? 'Saved ✓' : 'Save Trail' }}
            </button>

            <button
              class="btn-complete"
              [class.btn-complete--done]="isCompleted()"
              type="button"
              (click)="toggleComplete()"
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="9"
                        [attr.fill]="isCompleted() ? 'currentColor' : 'none'"
                        stroke="currentColor" stroke-width="2"/>
                <polyline points="8 12 11 15 16 9"
                          stroke="currentColor" stroke-width="2.2"
                          stroke-linecap="round" stroke-linejoin="round"
                          [style.opacity]="isCompleted() ? '1' : '0.6'"/>
              </svg>
              {{ isCompleted() ? 'Completed ✓' : 'Mark as Completed' }}
            </button>
          </div>
        }
      </section>

      <!-- ── Description ───────────────────────────────────────────── -->
      <section class="trail-description glass">
        <h2>About This Trek</h2>
        <p class="desc-text">{{ trail()!.description }}</p>

        @if (trail()!.tags.length) {
          <div class="trail-tags">
            @for (tag of trail()!.tags; track tag) {
              <span class="tag">{{ tag }}</span>
            }
          </div>
        }
      </section>

      <!-- ── More Details CTA ──────────────────────────────────────── -->
      <div class="more-details-row">
        <button class="btn-more-details" disabled>More Details <span class="coming-soon">coming soon</span></button>
      </div>

      <!-- ── Reviews ──────────────────────────────────────────────── -->
      <section class="reviews-section">
        <h2 class="reviews-heading">Hiker Reviews</h2>

        <!-- ── Write a Review (logged-in users only) ─────────────── -->
        @if (isLoggedIn()) {
          <div class="review-form glass" [class.review-form--done]="submitted()">

            @if (submitted()) {
              <!-- Success state -->
              <div class="review-success">
                <span class="success-icon">✓</span>
                <p>Your review has been posted — thanks for sharing!</p>
              </div>

            } @else {
              <h3 class="form-heading">Share Your Experience</h3>

              <!-- Star picker -->
              <div class="star-picker" role="group" aria-label="Trail rating">
                @for (n of starOptions; track n) {
                  <button
                    type="button"
                    class="star-pick"
                    [class.star-pick--active]="n <= (hoverRating() || reviewRating())"
                    (click)="setRating(n)"
                    (mouseenter)="setHover(n)"
                    (mouseleave)="clearHover()"
                    [attr.aria-label]="n + (n === 1 ? ' star' : ' stars')"
                  >★</button>
                }
                @if (reviewRating()) {
                  <span class="picker-label">{{ ratingLabel() }}</span>
                }
              </div>

              <!-- Review text -->
              <textarea
                class="review-textarea"
                rows="4"
                placeholder="Tell fellow hikers about your experience on this trail…"
                [value]="reviewBody()"
                (input)="onBodyInput($event)"
              ></textarea>

              <!-- Submit row -->
              <div class="form-footer">
                <button
                  type="button"
                  class="btn-submit-review"
                  [disabled]="reviewRating() === 0 || !reviewBody().trim() || submitting()"
                  (click)="submitReview()"
                >{{ submitting() ? 'Posting…' : 'Post Review' }}</button>

                @if (reviewRating() === 0) {
                  <span class="form-hint">Pick a star rating to continue</span>
                }
              </div>
            }

          </div>
        }

        <!-- Existing reviews grid -->
        <div class="reviews-grid">
          @for (review of reviews(); track review.id) {
            <article class="review-card glass">
              <div class="review-header">
                <div class="reviewer-avatar">{{ review.authorAvatarInitials }}</div>
                <div class="reviewer-meta">
                  <span class="reviewer-name">{{ review.authorName }}</span>
                  <span class="review-date">{{ review.visitedOn }}</span>
                </div>
                <div class="review-stars">
                  @for (s of stars(review.rating); track $index) {
                    <span class="star" [class.star--filled]="s === 'filled'">★</span>
                  }
                </div>
              </div>
              <p class="review-text">{{ review.comment }}</p>
            </article>
          }
        </div>
      </section>

    </main>

  }
</div>
